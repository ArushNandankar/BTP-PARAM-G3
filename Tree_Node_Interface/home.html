<!DOCTYPE html>
<html>
  <head>
    <style>
      * {
        font-family: "Courier New", Courier, monospace;
      }
      .tree {
        padding: 20px;
      }

      .tree ul {
        position: relative;
        padding: 1em 0 0 1em;
        list-style: none;
        margin: 0;
      }

      .tree li {
        position: relative;
        padding: 0 0 1em 1em;
      }

      .tree li::before {
        content: "";
        position: absolute;
        top: 0;
        left: -1px;
        bottom: 0;
        width: 2px;
        background: #888;
      }

      .tree li::after {
        content: "";
        position: absolute;
        top: 1em;
        left: 0;
        width: 1em;
        height: 2px;
        background: #888;
      }

      .tree li:last-child::before {
        height: 1em;
        bottom: auto;
      }

      .tree-item {
        position: relative;
        padding: 3px 5px;
        display: inline-block;
      }

      .actions {
        display: inline-block;
        margin-left: 10px;
      }

      .add-btn,
      .delete-btn {
        padding: 2px 6px;
        margin: 0 2px;
        cursor: pointer;
        border: 1px solid #ccc;
        border-radius: 3px;
        background: #fff;
      }

      .add-btn:hover,
      .delete-btn:hover {
        background: #f0f0f0;
      }

      .delete-btn {
        color: #d33;
      }

      .input-form {
        display: none;
        margin: 5px 0;
        padding: 5px;
      }

      .input-form.active {
        display: block;
      }

      .input-form input {
        padding: 4px;
        margin-right: 5px;
      }

      .expand-btn {
        cursor: pointer;
        user-select: none;
        margin-right: 5px;
      }

      .collapsed > ul {
        display: none;
      }

      .tree-controls {
        margin-bottom: 20px;
      }

      .tree-controls button {
        padding: 8px 16px;
        margin-right: 10px;
        cursor: pointer;
        background: #f0f0f0;
        border: 1px solid #ccc;
        border-radius: 4px;
      }

      .tree-controls button:hover {
        background: #e0e0e0;
      }

      /* Add new folder contents box style */
      #folder-contents-box {
        display: none;
        position: absolute;
        right: 10%;
        top: 10%;
        width: 50%;
        border: 1px solid #ccc;
        background: #fff;
        padding: 10px;
      }

      .file-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      .file-list li {
        padding: 5px;
        cursor: pointer;
      }

      .file-list li:hover {
        background: #f0f0f0;
      }


      /* Additional spacing in the root details box */
      #folder-contents-box .file-list li {
        margin-bottom: 15px;
        line-height: 1.6;
      }
      #folder-contents-box .file-list li input {
        display: block;
        margin-bottom: 5px;
      }
    </style>
  </head>
  <body>
    <div class="tree-controls">
      <button onclick="saveTree()">Save Tree</button>
      <input
      type="file"
      id="loadFile"
      style="display: none"
      onchange="loadTree(event)"
      />
      <button onclick="document.getElementById('loadFile').click()">
        Load Tree
      </button>
      <label>
        <input type="checkbox" id="adminSwitch" onchange="toggleAdminMode()" />
        Admin Mode
      </label>
      <br />
      <br />
      <label for="languageSelect">Select Language:</label>
      <select id="languageSelect">
        <option value="English" data-language="English">English</option>
        <option value="Gujarati" data-language="Gujarati">Gujarati</option>
        <option value="Kannada" data-language="Kannada">Kannada</option>
        <option value="Hindi" data-language="Hindi">Hindi</option>
        <option value="Telugu" data-language="Telugu">Telugu</option>
        <option value="Tamil" data-language="Tamil">Tamil</option>
        <option value="Punjabi" data-language="Punjabi">Punjabi</option>
        <option value="Odia" data-language="Odia">Odia</option>
        <option value="Urdu" data-language="Urdu">Urdu</option>
        <option value="Sindhi" data-language="Sindhi">Sindhi</option>
        <option value="Kashmiri" data-language="Kashmiri">Kashmiri</option>
      </select>
    </div>
    <div class="tree">
      <ul id="root">
        <li>
          <div class="tree-item root-item">
            <span class="expand-btn">[-]</span>
            <span class="name">root</span>
            <div class="actions">
              <button class="add-btn" onclick="showAddForm(this)">+</button>
            </div>
            <div class="input-form">
              <input type="text" placeholder="Name" />
              <button onclick="addItem(this)">Add</button>
            </div>
          </div>
          <ul></ul>
        </li>
      </ul>
    </div>

    <!-- New folder contents box -->
    <div id="folder-contents-box">
      <h3>
        Type Details
        <span
          style="float: right; cursor: pointer"
          onclick="closeFolderContentsBox()"
          >[x]</span
        >
      </h3>
      <label>Type Name: <span id="folder-name-display"></span></label>
      <br /><br />
      <label>Type Description:
        <br />
        <br />
        <textarea
          id="folder-field1"
          rows="1"
          style="overflow: hidden; width: 100%; resize: vertical; height: 70px"
          oninput="this.style.height='auto'; this.style.height=this.scrollHeight+'px';"
        ></textarea>
      </label>
      <br /><br />
      <h4>Examples for this type:</h4>
      <ul class="file-list" id="folder-files"></ul>
      <button onclick="addExample()">Add Example</button>
      <button onclick="saveExample()">Save Example</button>
      <button onclick="saveFolderDetails()">Save Root Details</button>
    </div>

    <script>
      // Keep all original functions
      function initializeExpandButtons() {
        document.querySelectorAll(".expand-btn").forEach((btn) => {
          btn.addEventListener("click", function () {
            const li = this.closest("li");
            const isCollapsed = li.classList.contains("collapsed");
            this.textContent = isCollapsed ? "[-]" : "[+]";
            li.classList.toggle("collapsed");
          });
        });
      }

      initializeExpandButtons();

      function showAddForm(button) {
        const form = button.parentElement.nextElementSibling;
        form.classList.toggle("active");
      }

      function addItem(button) {
        const form = button.parentElement;
        const input = form.querySelector("input");
        const select = form.querySelector("select");
        const name = input.value.trim();

        if (!name) return;

        const parentLi = form.parentElement.parentElement;
        let parentUl = parentLi.querySelector("ul");

        if (!parentUl) {
          parentUl = document.createElement("ul");
          parentLi.appendChild(parentUl);
        }

        const newLi = document.createElement("li");
        newLi.innerHTML = `
          <div class="tree-item "root-item">
            <span class="expand-btn">[-]</span>
            <span class="name">${name}</span>
            <div class="actions">
              <button class="add-btn" onclick="showAddForm(this)">+</button>
              <button class="delete-btn" onclick="deleteItem(this)">×</button>
            </div>
            <div class="input-form">
              <input type="text" placeholder="Name">
              <button onclick="addItem(this)">Add</button>
            </div>
          </div>
          <ul></ul>
        `;

        const expandBtn = newLi.querySelector(".expand-btn");
        expandBtn.addEventListener("click", function () {
          const li = this.closest("li");
          const isCollapsed = li.classList.contains("collapsed");
          this.textContent = isCollapsed ? "[-]" : "[+]";
          li.classList.toggle("collapsed");
        });

        parentUl.appendChild(newLi);
        input.value = "";
        form.classList.remove("active");
      }

      function deleteItem(button) {
        const li = button.closest("li");
        if (
          confirm(
            "Are you sure you want to delete this item and all its contents?"
          )
        ) {
          li.remove();
        }
      }

      // Show details box when clicking a file name
      document.addEventListener("click", function (e) {
        // Show folder contents when clicking a directory name
        if (e.target.classList.contains("name")) {
          const li = e.target.closest("li");
          showFolderContents(li);
        }
      });

      let currentFolderLi = null;

      // New function to show folder contents
      function showFolderContents(directoryLi) {
        currentFolderLi = directoryLi;
        document.getElementById("folder-name-display").textContent =
          directoryLi.querySelector(".name").textContent;

        const folderDetails = directoryLi.dataset.details
          ? JSON.parse(directoryLi.dataset.details)
          : { field1: "", field2: "", field3: "" };
        document.getElementById("folder-field1").value =
          folderDetails.field1 || "";

        // Populate file data
        const filesList = document.getElementById("folder-files");
        filesList.innerHTML = "";
        const examples = directoryLi.dataset.examples
          ? JSON.parse(directoryLi.dataset.examples)
          : [];

        examples.forEach((example) => {
          const listItem = document.createElement("li");

          const fileNameSpan = document.createElement("span");
          fileNameSpan.textContent = example.language;

          const fileField2 = document.createElement("textarea");
          fileField2.style.overflow = "hidden";
          fileField2.style.resize = "vertical";
          fileField2.style.width = "100%";
          fileField2.style.height = "70px";
          fileField2.value = example.description;

          const deleteBtn = document.createElement("button");
          deleteBtn.textContent = "Delete";
          deleteBtn.className = "delete-btn";
          deleteBtn.onclick = function () {
            if (confirm("Are you sure you want to delete this example?")) {
              listItem.remove();
            }
          };

          listItem.appendChild(fileNameSpan);
          listItem.appendChild(document.createElement("br"));
          listItem.appendChild(fileField2);
          listItem.appendChild(deleteBtn);
          filesList.appendChild(listItem);
        });

        document.getElementById("folder-contents-box").style.display = "block";

        toggleAdminMode(); // Ensure the delete button visibility is updated
      }

      function closeFolderContentsBox() {
        document.getElementById("folder-contents-box").style.display = "none";
      }

      function saveFolderDetails() {
        if (!currentFolderLi) return;

        const folderDetails = {
          field1: document.getElementById("folder-field1").value,
        };
        currentFolderLi.dataset.details = JSON.stringify(folderDetails);

        const filesListItems = document
          .getElementById("folder-files")
          .querySelectorAll("li");
        const fileItems = currentFolderLi.querySelectorAll(".node-item");

        fileItems.forEach((item, index) => {
          const textareas = filesListItems[index].querySelectorAll("textarea");
          const newField1 = textareas[0].value;
          const newField2 = textareas[1].value;

          item.closest("li").dataset.details = JSON.stringify({
            field1: newField1,
            field2: newField2,
          });
        });

        alert("Folder details updated!");
        closeFolderContentsBox();
      }

      // Function to add a new example
      function addExample() {
        const filesList = document.getElementById("folder-files");
        const listItem = document.createElement("li");

        const languageSelect = document.getElementById("languageSelect");
        const selectedLanguage = languageSelect.value;

        const fileNameSpan = document.createElement("span");
        fileNameSpan.textContent = selectedLanguage;

        // This new example's textarea will be editable only for admin users
        const fileField2 = document.createElement("textarea");
        fileField2.style.overflow = "hidden";
        fileField2.style.resize = "vertical";
        fileField2.style.width = "100%";
        fileField2.style.height = "70px";
        fileField2.readOnly = document.getElementById("adminSwitch").checked ? false : true;

        const deleteBtn = document.createElement("button");
        deleteBtn.textContent = "Delete";
        deleteBtn.className = "delete-btn";
        deleteBtn.onclick = function () {
          if (confirm("Are you sure you want to delete this example?")) {
            listItem.remove();
          }
        };

        listItem.appendChild(fileNameSpan);
        listItem.appendChild(document.createElement("br"));
        listItem.appendChild(fileField2);
        listItem.appendChild(deleteBtn);
        filesList.appendChild(listItem);

        // Update the examples dataset
        const examples = JSON.parse(currentFolderLi.dataset.examples || "[]");
        examples.push({ language: selectedLanguage, description: "" });
        currentFolderLi.dataset.examples = JSON.stringify(examples);

        toggleAdminMode(); // Ensure the delete button visibility is updated
      }

      // Function to save the example
      function saveExample() {
        if (!currentFolderLi) return;

        const filesList = document.getElementById("folder-files");
        const examples = [];

        filesList.querySelectorAll("li").forEach((listItem) => {
          const language = listItem.querySelector("span").textContent;
          const description = listItem.querySelector("textarea").value;
          examples.push({ language, description });
        });

        currentFolderLi.dataset.examples = JSON.stringify(examples);

        console.log("Saved Examples:", examples);
        alert("Examples saved successfully!");
      }

      // Keep all original tree save/load functions
      function treeToJson(element) {
        const items = [];
        const lis = element.children;

        for (let li of lis) {
          const item = {};
          const nameSpan = li.querySelector(".name");
          item.name = nameSpan.textContent;
          item.type = li.querySelector(".tree-item").classList.contains("root-item") ? "root" : "node";
          item.collapsed = li.classList.contains("collapsed");
          if (li.dataset.details) {
            item.details = JSON.parse(li.dataset.details);
          }
          if (li.dataset.examples) {
            item.examples = JSON.parse(li.dataset.examples);
          }

          const ul = li.querySelector("ul");
          if (ul && ul.children.length > 0) {
            item.children = treeToJson(ul);
          }

          items.push(item);
        }

        return items;
      }

      // Save tree to JSON file
      async function saveTree() {
        const root = document.getElementById("root");
        const treeData = treeToJson(root);
        const jsonString = JSON.stringify(treeData, null, 2);

        if (window.showSaveFilePicker) {
          try {
            const handle = await window.showSaveFilePicker({
              suggestedName: "tree-structure.json",
              types: [
                {
                  description: "JSON Files",
                  accept: { "application/json": [".json"] },
                },
              ],
            });
            const writable = await handle.createWritable();
            await writable.write(jsonString);
            await writable.close();
            alert("File saved successfully!");
          } catch (error) {
            console.error("File save failed", error);
          }
        } else {
          // Fallback for unsupported browsers
          const blob = new Blob([jsonString], { type: "application/json" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "tree-structure.json";
          a.click();
          URL.revokeObjectURL(url);
        }
      }

      // Load tree from JSON file
      function loadTree(event) {
        const file = event.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = function (e) {
            try {
              const treeData = JSON.parse(e.target.result);
              const root = document.getElementById("root");
              root.innerHTML = "";

              function createTreeElement(items) {
                const fragment = document.createDocumentFragment();

                items.forEach((item) => {
                  const li = document.createElement("li");
                  if (item.collapsed) li.classList.add("collapsed");

                  const isRoot = item.type === "root";
                  li.innerHTML = `
                    <div class="tree-item ${isRoot ? "root-item" : "node-item"}">
                      <span class="expand-btn">${item.collapsed ? "[+]" : "[-]"}</span>
                      <span class="name">${item.name}</span>
                      <div class="actions">
                        <button class="add-btn" onclick="showAddForm(this)">+</button>
                        <button class="delete-btn" onclick="deleteItem(this)">×</button>
                      </div>
                      <div class="input-form">
                        <input type="text" placeholder="Name">
                        <select>
                          <option value="node">Node</option>
                          <option value="root">Root</option>
                        </select>
                        <button onclick="addItem(this)">Add</button>
                      </div>
                    </div>
                  `;
                  if (item.details) {
                    li.dataset.details = JSON.stringify(item.details);
                  }
                  if (item.examples) {
                    li.dataset.examples = JSON.stringify(item.examples);
                  }

                  if (item.children) {
                    const ul = document.createElement("ul");
                    ul.appendChild(createTreeElement(item.children));
                    li.appendChild(ul);
                  }

                  fragment.appendChild(li);
                });

                return fragment;
              }

              root.appendChild(createTreeElement(treeData));
              initializeExpandButtons();
            } catch (error) {
              alert("Error loading file: " + error.message);
            }
          };
          reader.readAsText(file);
        }
      }

      // Initialize all items
      document.querySelectorAll(".tree-item").forEach((item) => {
        const isDirectory = item.closest("li").querySelector("ul") !== null;
      });

      // Function to toggle admin mode
      function toggleAdminMode() {
        const isAdmin = document.getElementById("adminSwitch").checked;
        // Applies to the tree controls (add and delete buttons within tree items)
        document.querySelectorAll(".add-btn, .delete-btn").forEach((btn) => {
          btn.style.display = isAdmin ? "inline-block" : "none";
        });

        // Make Type Description editable only in admin mode
        document.getElementById("folder-field1").disabled = !isAdmin;

        // Disable English option if not admin
        const englishOption = document.querySelector('#languageSelect option[value="English"]');
        if (!isAdmin) {
          englishOption.disabled = true;
          if (document.getElementById("languageSelect").value === "English") {
            document.getElementById("languageSelect").value = "Gujarati"; // Default to another language
          }
        } else {
          englishOption.disabled = false;
        }

        // Refresh the examples list to update visibility based on the current admin state
        filterExamples();
      }

      // Function to filter examples based on selected language and admin status
      function filterExamples() {
        // Ensure a folder is selected
        if (!currentFolderLi) return;

        const selectedLanguage = document.getElementById("languageSelect").value;
        const isAdmin = document.getElementById("adminSwitch").checked;
        const filesList = document.getElementById("folder-files");
        const examples = JSON.parse(currentFolderLi.dataset.examples || "[]");

        filesList.innerHTML = "";
        examples.forEach((example) => {
          // If admin, show all examples; if not, show only those matching selected language or English
          // if (isAdmin || example.language === selectedLanguage || example.language === "English") {

            const listItem = document.createElement("li");

            const fileNameSpan = document.createElement("span");
            fileNameSpan.textContent = example.language;

            const fileField2 = document.createElement("textarea");
            fileField2.style.overflow = "hidden";
            fileField2.style.resize = "vertical";
            fileField2.style.width = "100%";
            fileField2.style.height = "70px";
            fileField2.value = example.description;
            // For non-admin users, make the textarea readonly if the language is not the selected one
            fileField2.readOnly = !isAdmin && example.language !== selectedLanguage;

            const deleteBtn = document.createElement("button");
            deleteBtn.textContent = "Delete";
            deleteBtn.className = "delete-btn";
            // Only show delete button for admin users
            deleteBtn.style.display = isAdmin ? "inline-block" : "none";
            deleteBtn.onclick = function () {
              if (confirm("Are you sure you want to delete this example?")) {
                listItem.remove();
              }
            };

            // if the language is different from the selected language hide it
            if (!isAdmin && (example.language !== selectedLanguage && example.language !== "English")) {
              listItem.style.display = "none";
            }

            listItem.appendChild(fileNameSpan);
            listItem.appendChild(document.createElement("br"));
            listItem.appendChild(fileField2);
            listItem.appendChild(deleteBtn);
            filesList.appendChild(listItem);
          // }
        });
      }

      // Call filterExamples when language is changed
      document.getElementById("languageSelect").addEventListener("change", filterExamples);

      // Call toggleAdminMode on page load to set initial state
      toggleAdminMode();
    </script>
  </body>
</html>
